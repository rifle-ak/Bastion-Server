#!/usr/bin/env bash
# bastion — Unified CLI for the Bastion Agent
#
# Installed to /usr/local/bin/bastion so staff can just type:
#
#   bastion "check disk space on gameserver-01"   Send a one-shot query
#   bastion -i                                    Start interactive session
#   bastion -v "check disk space"                 Verbose output
#   bastion -r <id> "follow up question"          Resume a session
#   bastion sessions                              List saved sessions
#   bastion status                                Check if the agent is running
#   bastion logs                                  View recent agent logs
#   bastion update                                Pull latest code & restart
#   bastion run                                   Start interactive (no daemon)
#   bastion check-config                          Validate configuration
#   bastion help                                  Show this help
#
# The API key is loaded from /etc/bastion-agent/env (root-only, 0600)
# and passed via process environment — it never appears in ps output.

set -euo pipefail

ENV_FILE="/etc/bastion-agent/env"
CONFIG_DIR="/etc/bastion-agent"
INSTALL_DIR="/opt/bastion-agent"
AGENT_BIN="${INSTALL_DIR}/venv/bin/bastion-agent"
AGENT_USER="claude-agent"
SOCKET="/run/bastion-agent/agent.sock"

# ─── Colors (disabled if not a terminal) ──────────────────────────────────

if [[ -t 1 ]]; then
    GREEN='\033[0;32m'
    RED='\033[0;31m'
    YELLOW='\033[1;33m'
    CYAN='\033[0;36m'
    DIM='\033[2m'
    BOLD='\033[1m'
    RESET='\033[0m'
else
    GREEN='' RED='' YELLOW='' CYAN='' DIM='' BOLD='' RESET=''
fi

# ─── Auto-elevate to root (needed to read the secure env file) ───────────

if [[ $EUID -ne 0 ]]; then
    exec sudo "$0" "$@"
fi

# ─── Help ─────────────────────────────────────────────────────────────────

show_help() {
    echo -e "${BOLD}Bastion Agent${RESET} — Infrastructure management for Galaxy Gaming Host"
    echo ""
    echo -e "${BOLD}Usage:${RESET}"
    echo -e "  bastion \"your question here\"         Send a query to the agent"
    echo -e "  bastion -i                            Interactive conversation"
    echo -e "  bastion -v \"your question\"            Verbose output (show tool details)"
    echo -e "  bastion -r <session-id> \"follow up\"   Resume a previous session"
    echo ""
    echo -e "${BOLD}Management:${RESET}"
    echo -e "  bastion status                        Check if the agent is running"
    echo -e "  bastion logs                          View recent agent logs"
    echo -e "  bastion logs -f                       Follow logs in real time"
    echo -e "  bastion sessions                      List saved sessions"
    echo -e "  bastion update                        Pull latest code & restart service"
    echo -e "  bastion restart                       Restart the agent service"
    echo ""
    echo -e "${BOLD}Advanced:${RESET}"
    echo -e "  bastion run                           Start interactive mode (no daemon)"
    echo -e "  bastion check-config                  Validate configuration files"
    echo -e "  bastion help                          Show this help message"
    echo ""
    echo -e "${DIM}Config: ${CONFIG_DIR}  |  Logs: journalctl -u bastion-agent${RESET}"
}

# ─── Validate installation ────────────────────────────────────────────────

check_install() {
    if [[ ! -x "$AGENT_BIN" ]]; then
        echo -e "${RED}Error:${RESET} Agent not installed at $AGENT_BIN" >&2
        echo "Run: sudo bash ${INSTALL_DIR}/install.sh" >&2
        exit 1
    fi
}

check_env() {
    if [[ ! -f "$ENV_FILE" ]]; then
        echo -e "${RED}Error:${RESET} $ENV_FILE not found." >&2
        echo "Run: sudo bash ${INSTALL_DIR}/install.sh" >&2
        exit 1
    fi

    if grep -q "sk-ant-your-key-here" "$ENV_FILE" 2>/dev/null; then
        echo -e "${RED}Error:${RESET} API key not configured." >&2
        echo "Edit:  sudo nano $ENV_FILE" >&2
        exit 1
    fi
}

load_env() {
    set -a
    . "$ENV_FILE"
    set +a
    export BASTION_AGENT_LOG_LEVEL="${BASTION_AGENT_LOG_LEVEL:-INFO}"
}

# ─── Subcommands ──────────────────────────────────────────────────────────

cmd_status() {
    echo -e "${BOLD}Agent Service${RESET}"
    systemctl is-active bastion-agent > /dev/null 2>&1 && \
        echo -e "  Status:  ${GREEN}running${RESET}" || \
        echo -e "  Status:  ${RED}stopped${RESET}"
    echo ""

    # Show if the socket exists
    if [[ -S "$SOCKET" ]]; then
        echo -e "  Socket:  ${GREEN}${SOCKET}${RESET}"
    else
        echo -e "  Socket:  ${RED}not found${RESET} (daemon not running?)"
    fi
    echo ""

    # Brief systemctl output
    systemctl status bastion-agent --no-pager -l 2>/dev/null | head -15 || true
}

cmd_logs() {
    local ARGS=(-u bastion-agent --no-pager)

    # Check for -f (follow) flag
    if [[ "${1:-}" == "-f" ]]; then
        ARGS=(-u bastion-agent -f)
        shift
    fi

    # Default to last 50 lines
    if [[ ! " ${ARGS[*]} " =~ " -f " ]]; then
        ARGS+=(-n 50)
    fi

    journalctl "${ARGS[@]}"
}

cmd_sessions() {
    check_install
    check_env
    load_env
    exec runuser -u "$AGENT_USER" -- "$AGENT_BIN" send --sessions \
        --sessions-dir "${INSTALL_DIR}/sessions" \
        --socket "$SOCKET"
}

cmd_update() {
    echo -e "${BOLD}Updating Bastion Agent${RESET}"
    echo ""

    check_install

    # Pull latest code
    echo -e "  ${CYAN}[1/4]${RESET} Pulling latest code..."
    cd "$INSTALL_DIR"
    git pull origin main --quiet 2>&1 && \
        echo -e "  ${GREEN}[+]${RESET} Code updated" || {
            echo -e "  ${RED}[x]${RESET} Git pull failed" >&2
            exit 1
        }

    # Reinstall Python package (picks up new dependencies + code)
    echo -e "  ${CYAN}[2/4]${RESET} Installing dependencies..."
    "${INSTALL_DIR}/venv/bin/pip" install --quiet -r requirements.txt
    "${INSTALL_DIR}/venv/bin/pip" install --quiet -e .
    echo -e "  ${GREEN}[+]${RESET} Dependencies updated"

    # Update systemd service file
    echo -e "  ${CYAN}[3/4]${RESET} Updating service..."
    cp "${INSTALL_DIR}/systemd/bastion-agent.service" /etc/systemd/system/bastion-agent.service
    systemctl daemon-reload
    echo -e "  ${GREEN}[+]${RESET} Service file updated"

    # Ensure directories exist with correct ownership
    mkdir -p "${INSTALL_DIR}/sessions" "${INSTALL_DIR}/logs"
    chown "${AGENT_USER}:${AGENT_USER}" "${INSTALL_DIR}/sessions" "${INSTALL_DIR}/logs"

    # Restart
    echo -e "  ${CYAN}[4/4]${RESET} Restarting agent..."
    systemctl restart bastion-agent
    sleep 1

    if systemctl is-active bastion-agent > /dev/null 2>&1; then
        echo ""
        echo -e "  ${GREEN}${BOLD}Update complete — agent is running${RESET}"
        VERSION=$("${INSTALL_DIR}/venv/bin/bastion-agent" --version 2>&1 | tail -1)
        echo -e "  ${DIM}${VERSION}${RESET}"
    else
        echo ""
        echo -e "  ${RED}${BOLD}Agent failed to start after update${RESET}"
        echo -e "  Check logs: ${CYAN}bastion logs${RESET}"
        exit 1
    fi
}

cmd_restart() {
    echo -e "Restarting bastion-agent..."
    systemctl restart bastion-agent
    sleep 1
    if systemctl is-active bastion-agent > /dev/null 2>&1; then
        echo -e "${GREEN}Agent is running${RESET}"
    else
        echo -e "${RED}Agent failed to start${RESET}"
        echo "Check logs: bastion logs"
        exit 1
    fi
}

cmd_send() {
    check_install
    check_env
    load_env

    # Check daemon is running
    if ! systemctl is-active bastion-agent > /dev/null 2>&1; then
        echo -e "${RED}Error:${RESET} Agent daemon is not running." >&2
        echo "Start it:  bastion restart" >&2
        exit 1
    fi

    exec runuser -u "$AGENT_USER" -- "$AGENT_BIN" send \
        --socket "$SOCKET" "$@"
}

cmd_run() {
    check_install
    check_env
    load_env
    exec runuser -u "$AGENT_USER" -- "$AGENT_BIN" run --config-dir "$CONFIG_DIR" "$@"
}

cmd_check_config() {
    check_install
    exec "$AGENT_BIN" check-config --config-dir "$CONFIG_DIR" "$@"
}

# ─── Argument parsing ─────────────────────────────────────────────────────

# No arguments → help
if [[ $# -eq 0 ]]; then
    show_help
    exit 0
fi

case "$1" in
    help|--help|-h)
        show_help
        ;;
    status)
        cmd_status
        ;;
    logs)
        shift
        cmd_logs "$@"
        ;;
    sessions)
        cmd_sessions
        ;;
    update)
        cmd_update
        ;;
    restart)
        cmd_restart
        ;;
    run)
        shift
        cmd_run "$@"
        ;;
    check-config)
        shift
        cmd_check_config "$@"
        ;;
    # ── Everything else → send to the agent ────────────────────────
    # This handles:  bastion "question"
    #                bastion -v "question"
    #                bastion -i
    #                bastion -r <id> "question"
    *)
        cmd_send "$@"
        ;;
esac
